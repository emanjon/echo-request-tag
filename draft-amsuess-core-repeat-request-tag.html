<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>Repeat And Request-Tag</title>

  
<style type="text/css">/*<![CDATA[*/
@viewport {
  zoom: 1.0;
  width: extend-to-zoom;
}
@-ms-viewport {
  width: extend-to-zoom;
  zoom: 1.0;
}

@media screen and (min-width: 1024px) {
  ul.toc, #rfc\.toc {
    position: fixed;
    bottom: 0;
    right: 0;
    right: calc(50vw - 500px);
    width: 300px;
    padding: 0 1em;
    z-index: 1;
  }
  #rfc\.toc {
    top: 16px;
  }
  ul.toc {
    top: 80px;
    overflow: auto;
  }

  body {
    padding-left: 1.5em;
    padding-right: 29em;
  }
}

body {
  font: 15px "Helvetica Neue",Helvetica,Arial,sans-serif;
  color: #333;
  font-size-adjust: 0.5;
  line-height: 130%;
  margin: 2.5em auto;
  max-width: 724px;
}

.title, .filename, h1, h2, h3, h4 {
  font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
  font-size-adjust: 0.5;
  font-weight: 500;
  color: #333;
  line-height: 100%;
  margin: 0.8em 0 0.3em;
}
.title { font-size: 36px; }
h1 { font-size: 30px; }
h2 { font-size: 24px; }
h3, h4 { font-size: 18px; }
h1 a[href], h2 a[href], h3 a[href], h4 a[href] {
  color: #333;
}

ul.toc li {
  list-style: none;
  text-indent: -2.5em;
  padding-left: 2.5em;
  padding-bottom: 5px;
  margin: 0;
}
ul.toc ul {
  margin: 0;
}
/* xml2rfc nests ul directly inside ul which messes with the style badly */
ul.toc, ul.toc>ul, ul.toc ul>ul {
  margin: 0 0 0 1.5em;
}

table {
  margin-left: 0em;
  border-collapse: collapse;
}
th {
  text-align: left;
  border-bottom: 2px solid #ddd;
}
td {
  border-top: 1px solid #ddd;
  vertical-align: top;
}
tr:nth-child(2n+1) > td,
tr:nth-child(2n+1) > th {
  background-color: #f9f9f9;
}
td.reference {
  max-width: 200px;
  border-top: none;
  padding-right: 1em;
}
.right {
  text-align: right;
}


table.header {
  width: 100%;
}
table.header td {
  border: none;
  background-color: transparent;
  color: black;
}
.filename {
  color: rgb(119, 119, 119);
  font-size: 23px;
  font-weight: normal;
  height: auto;
  line-height: 100%;
}
#rfc\.abstract+p {
  font-size: 20px;
  font-weight: 300;
  line-height: 130%;
}

samp, tt, code, pre {
  font: 11pt consolas, monospace;
  font-size-adjust: none;
}
pre {
  background-color: #eee;
  border: 1px solid #ddd;
  overflow-x: auto;
  padding: 5px;
  margin: 5px;
}
.figure {
  font-style: italic;
  margin: 0 1.5em;
}

address {
  margin: 10px 0 0;
}
.vcard {
  font-style: normal;
}
.vcardline {
  display: block;
}
.vcardline .fn {
  font-weight: bold;
}
.vcardline .hidden {
  display: none;
}

dl {
  margin-left: 1em;
}
dl.dl-horizontal: {
  margin-left: 0;
}
dl > dt {
  float: left;
  margin-right: 1em;
}
dl.nohang > dt {
  float: none;
}
dl > dd {
  margin-bottom: .5em;
}
dl.compact > dd {
  margin-bottom: 0em;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0em;
}
ul.empty {
  list-style-type: none;
}
ul.empty li {
  margin-top: .5em;
}

hr {
  border: 0;
  border-top: 1px solid #eee;
}

a {
  text-decoration: none;
}
a[href] {
  color: #2a6496;
}
a[href]:hover {
  background-color: #eee;
}

ol, ul, li, p {
  padding: 0;
  margin: 0.5em 0 0.5em 2em;
}
li, p {
  margin-left: 0;
}
address {
  font-style: normal;
}

.github-fork-ribbon-wrapper {
  display: none;
}
@media screen and (min-width: 800px) {
  /* "Fork me on GitHub" CSS ribbon based on
   * https://github.com/simonwhitaker/github-fork-ribbon-css
   */
  .github-fork-ribbon {
    position: absolute;
    padding: 2px 0;
    background-color: #a00;
    background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));
    box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);
    font: 700 12px "Helvetica Neue", Helvetica, Arial, sans-serif;

    pointer-events: auto;

    top: 38px;
    right: -45px;

    transform: rotate(45deg);
  }

  .github-fork-ribbon a[href],
  .github-fork-ribbon a[href]:hover {
    color: #fff;
    background-color: transparent;
    text-decoration: none;
    text-shadow: 0 -1px rgba(0, 0, 0, 0.5);
    text-align: center;

    width: 190px;
    line-height: 18px;

    display: inline-block;
    padding: 2px 0;

    border: 1.5px dotted #fff;
    border-color: rgba(255, 255, 255, 0.6);
  }

  .github-fork-ribbon-wrapper {
    display: block;
    width: 130px;
    height: 130px;
    position: absolute;
    overflow: hidden;
    top: 0; right: 0;
    z-index: 2;
    pointer-events: none;
  }
}
@media screen and (min-width: 1000px) {
  .github-fork-ribbon-wrapper {
    position: fixed;
  }
  /*]]>*/</style>


  <link href="#rfc.toc" rel="Contents"/>
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction"/>
<link href="#rfc.section.1.1" rel="Chapter" title="1.1 Request Freshness"/>
<link href="#rfc.section.1.2" rel="Chapter" title="1.2 Fragmented Message Body Integrity"/>
<link href="#rfc.section.1.2.1" rel="Chapter" title="1.2.1 Terminology"/>
<link href="#rfc.section.2" rel="Chapter" title="2 The Repeat Option"/>
<link href="#rfc.section.2.1" rel="Chapter" title="2.1 Option Format"/>
<link href="#rfc.section.2.2" rel="Chapter" title="2.2 Repeat Processing"/>
<link href="#rfc.section.2.3" rel="Chapter" title="2.3 Applications"/>
<link href="#rfc.section.3" rel="Chapter" title="3 The Request-Tag Option"/>
<link href="#rfc.section.3.1" rel="Chapter" title="3.1 Option Format"/>
<link href="#rfc.section.3.2" rel="Chapter" title="3.2 Request-Tag Processing"/>
<link href="#rfc.section.3.3" rel="Chapter" title="3.3 Applications"/>
<link href="#rfc.section.3.3.1" rel="Chapter" title="3.3.1 Parallel blockwise transfers"/>
<link href="#rfc.section.3.3.2" rel="Chapter" title="3.3.2 Body integrity based on Payload integrity"/>
<link href="#rfc.section.4" rel="Chapter" title="4 The ETag Option"/>
<link href="#rfc.section.5" rel="Chapter" title="5 IANA Considerations"/>
<link href="#rfc.section.6" rel="Chapter" title="6 Security Considerations"/>
<link href="#rfc.section.7" rel="Chapter" title="7 Appendix"/>
<link href="#rfc.section.7.1" rel="Chapter" title="7.1 Minimizing the state kept for the Repeat Opption"/>
<link href="#rfc.references" rel="Chapter" title="8 References"/>
<link href="#rfc.references.1" rel="Chapter" title="8.1 Normative References"/>
<link href="#rfc.references.2" rel="Chapter" title="8.2 Informative References"/>
<link href="#rfc.authors" rel="Chapter"/>


  <meta name="generator" content="xml2rfc version 2.5.1 - http://tools.ietf.org/tools/xml2rfc" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />

  <meta name="dct.creator" content="Amsuess, C., Mattsson, J., and G. Selander" />
  <meta name="dct.identifier" content="urn:ietf:id:draft-amsuess-core-repeat-request-tag-latest" />
  <meta name="dct.issued" scheme="ISO8601" content="2017-6-21" />
  <meta name="dct.abstract" content="This document defines two optional extensions to the Constrained Application Protocol (CoAP): the Repeat option and the Request-Tag option. Each of these options when integrity protected, such as with DTLS or OSCOAP, protects against certain attacks on CoAP message exchanges." />
  <meta name="description" content="This document defines two optional extensions to the Constrained Application Protocol (CoAP): the Repeat option and the Request-Tag option. Each of these options when integrity protected, such as with DTLS or OSCOAP, protects against certain attacks on CoAP message exchanges." />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
  <td class="left">CoRE Working Group</td>
  <td class="right">C. Amsuess</td>
</tr>
<tr>
  <td class="left">Internet-Draft</td>
  <td class="right">Energy Harvesting Solutions</td>
</tr>
<tr>
  <td class="left">Updates: RFC7959 (if approved)</td>
  <td class="right">J. Mattsson</td>
</tr>
<tr>
  <td class="left">Intended status: Standards Track</td>
  <td class="right">G. Selander</td>
</tr>
<tr>
  <td class="left">Expires: December 23, 2017</td>
  <td class="right">Ericsson AB</td>
</tr>
<tr>
  <td class="left"></td>
  <td class="right">June 21, 2017</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">Repeat And Request-Tag<br />
  <span class="filename">draft-amsuess-core-repeat-request-tag-latest</span></p>
  
  <h1 id="rfc.abstract">
  <a href="#rfc.abstract">Abstract</a>
</h1>
<p>This document defines two optional extensions to the Constrained Application Protocol (CoAP): the Repeat option and the Request-Tag option. Each of these options when integrity protected, such as with DTLS or OSCOAP, protects against certain attacks on CoAP message exchanges.</p>
<p>The Repeat option enables a CoAP server to verify the freshness of a request by requiring the CoAP client to make another request and include a server-provided challenge. The Request-Tag option allows the CoAP server to match message fragments belonging to the same request message, fragmented using the CoAP Block-Wise Transfer mechanism.  This document also specifies additional processing requirements on Block1 and Block2 options.</p>
<h1 id="rfc.status">
  <a href="#rfc.status">Status of This Memo</a>
</h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet-Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on December 23, 2017.</p>
<h1 id="rfc.copyrightnotice">
  <a href="#rfc.copyrightnotice">Copyright Notice</a>
</h1>
<p>Copyright (c) 2017 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a></li>
<ul><li>1.1.   <a href="#rfc.section.1.1">Request Freshness</a></li>
<li>1.2.   <a href="#rfc.section.1.2">Fragmented Message Body Integrity</a></li>
<ul><li>1.2.1.   <a href="#rfc.section.1.2.1">Terminology</a></li>
</ul></ul><li>2.   <a href="#rfc.section.2">The Repeat Option</a></li>
<ul><li>2.1.   <a href="#rfc.section.2.1">Option Format</a></li>
<li>2.2.   <a href="#rfc.section.2.2">Repeat Processing</a></li>
<li>2.3.   <a href="#rfc.section.2.3">Applications</a></li>
</ul><li>3.   <a href="#rfc.section.3">The Request-Tag Option</a></li>
<ul><li>3.1.   <a href="#rfc.section.3.1">Option Format</a></li>
<li>3.2.   <a href="#rfc.section.3.2">Request-Tag Processing</a></li>
<li>3.3.   <a href="#rfc.section.3.3">Applications</a></li>
<ul><li>3.3.1.   <a href="#rfc.section.3.3.1">Parallel blockwise transfers</a></li>
<li>3.3.2.   <a href="#rfc.section.3.3.2">Body integrity based on Payload integrity</a></li>
</ul></ul><li>4.   <a href="#rfc.section.4">The ETag Option</a></li>
<li>5.   <a href="#rfc.section.5">IANA Considerations</a></li>
<li>6.   <a href="#rfc.section.6">Security Considerations</a></li>
<li>7.   <a href="#rfc.section.7">Appendix</a></li>
<ul><li>7.1.   <a href="#rfc.section.7.1">Minimizing the state kept for the Repeat Opption</a></li>
</ul><li>8.   <a href="#rfc.references">References</a></li>
<ul><li>8.1.   <a href="#rfc.references.1">Normative References</a></li>
<li>8.2.   <a href="#rfc.references.2">Informative References</a></li>
</ul><li><a href="#rfc.authors">Authors' Addresses</a></li>


  </ul>

  <h1 id="rfc.section.1"><a href="#rfc.section.1">1.</a> <a href="#intro" id="intro">Introduction</a></h1>
<p id="rfc.section.1.p.1">The initial CoAP suite of specifications (<a href="#RFC7252">[RFC7252]</a>, <a href="#RFC7641">[RFC7641]</a>, <a href="#RFC7959">[RFC7959]</a>) was designed with the assumption that security could be provided on a separate layer, in particular by using DTLS (<a href="#RFC6347">[RFC6347]</a>). However, for some use cases, additional functionality or extra processing is needed to support secure CoAP operations.</p>
<p id="rfc.section.1.p.2">This document specifies two server-oriented CoAP options, the Repeat option and the Request-Tag option, addressing the security features request freshness and fragmented message body integrity, respectively. These options in themselves do not replace the need for a security protocol; they specify the format and processing of data which, when integrity protected in a message, e.g. using DTLS (<a href="#RFC6347">[RFC6347]</a>) or OSCOAP (<a href="#I-D.ietf-core-object-security">[I-D.ietf-core-object-security]</a>), provide those security features. The Request-Tag option and also the ETag option are mandatory to use with Block1 and Block2, respectively, to secure blockwise operations with multiple representations of a particular resource as is specified in this document.</p>
<h1 id="rfc.section.1.1"><a href="#rfc.section.1.1">1.1.</a> <a href="#req-fresh" id="req-fresh">Request Freshness</a></h1>
<p id="rfc.section.1.1.p.1">A CoAP server receiving a request may not be able to verify when the request was sent by the CoAP client. This remains true even if the request was protected with a security protocol, such as DTLS. This makes CoAP requests vulnerable to certain delay attacks which are particularly incriminating in the case of actuators (<a href="#I-D.mattsson-core-coap-actuators">[I-D.mattsson-core-coap-actuators]</a>). Some attacks are possible to mitigate by establishing fresh session keys (e.g. performing the DTLS handshake) for each actuation, but in general this is not a solution suitable for constrained environments.</p>
<p id="rfc.section.1.1.p.2">A straightforward mitigation of potential delayed requests is that the CoAP server rejects a request the first time it appears and asks the CoAP client to prove that it intended to make the request at this point in time. The Repeat option, defined in this document, specifies such a mechanism which thereby enables the CoAP server to verify the freshness of a request. This mechanism is not only important in the case of actuators, or other use cases where the CoAP operations require freshness of requests, but also in general for synchronizing state between CoAP client and server.</p>
<h1 id="rfc.section.1.2"><a href="#rfc.section.1.2">1.2.</a> <a href="#body-int" id="body-int">Fragmented Message Body Integrity</a></h1>
<p id="rfc.section.1.2.p.1">CoAP was designed to work over unreliable transports, such as UDP, and include a lightweight reliability feature to handle messages which are lost or arrive out of order. In order for a security protocol to support CoAP operations over unreliable transports, it must allow out-of-order delivery of messages using e.g. a sliding replay window such as described in Section 4.1.2.6 of DTLS (<a href="#RFC6347">[RFC6347]</a>).</p>
<p id="rfc.section.1.2.p.2">The Block-Wise Transfer mechanism <a href="#RFC7959">[RFC7959]</a> extends CoAP by defining the transfer of a large resource representation (CoAP message body) as a sequence of blocks (CoAP message payloads). The mechanism uses a pair of CoAP options, Block1 and Block2, pertaining to the request and response payload, respectively. The blockwise functionality does not support the detection of interchanged blocks between different message bodies to the same endpoint having the same block number. This remains true even when CoAP is used together with a security protocol such as DTLS or OSCOAP, within the replay window (<a href="#I-D.amsuess-core-request-tag">[I-D.amsuess-core-request-tag]</a>), which is a vulnerability of CoAP when using RFC7959.</p>
<p id="rfc.section.1.2.p.3">A straightforward mitigation of mixing up blocks from different messages is to use unique identifiers for different message bodies, which would provide equivalent protection to the case where the complete body fits into a single payload. The ETag option <a href="#RFC7252">[RFC7252]</a>, set by the CoAP server, identifies a response body fragmented using the Block2 option. This document defines the Request-Tag option for identifying the request body fragmented using the Block1 option, similar to ETag, but ephemeral and set by the CoAP client.</p>
<h1 id="rfc.section.1.2.1"><a href="#rfc.section.1.2.1">1.2.1.</a> <a href="#terminology" id="terminology">Terminology</a></h1>
<p id="rfc.section.1.2.1.p.1">The key words &#8220;MUST&#8221;, &#8220;MUST NOT&#8221;, &#8220;REQUIRED&#8221;, &#8220;SHALL&#8221;, &#8220;SHALL NOT&#8221;, &#8220;SHOULD&#8221;, &#8220;SHOULD NOT&#8221;, &#8220;RECOMMENDED&#8221;, &#8220;MAY&#8221;, and &#8220;OPTIONAL&#8221; in this document are to be interpreted as described in <a href="#RFC2119">[RFC2119]</a>.</p>
<p id="rfc.section.1.2.1.p.2">The terms &#8220;payload&#8221; and &#8220;body&#8221; of a message are used as in <a href="#RFC7959">[RFC7959]</a>.  The complete interchange of a request and a response body is called a (REST) &#8220;operation&#8221;, while a request and response message (as matched by their tokens) is called an &#8220;exchange&#8221;. An operation fragmented using <a href="#RFC7959">[RFC7959]</a> is called a &#8220;blockwise operation&#8221;. A blockwise operation which is fragmenting the request body is called a &#8220;blockwise request operation&#8221;.</p>
<h1 id="rfc.section.2"><a href="#rfc.section.2">2.</a> <a href="#repeat" id="repeat">The Repeat Option</a></h1>
<p id="rfc.section.2.p.1">The Repeat option is a server-driven challenge-response mechanism for CoAP. The Repeat option value is a challenge from the server to the client included in a CoAP response and echoed in a CoAP request.</p>
<h1 id="rfc.section.2.1"><a href="#rfc.section.2.1">2.1.</a> <a href="#repeat-format" id="repeat-format">Option Format</a></h1>
<p id="rfc.section.2.1.p.1">The Repeat Option is elective, safe-to-forward, not part of the cache-key, and not repeatable, see <a href="#repeat-table">Figure 1</a>.</p>
<div id="rfc.figure.1"/>
<div id="repeat-table"/>
<pre>
+-----+---+---+---+---+-------------+--------+--------+---------+---+
| No. | C | U | N | R | Name        | Format | Length | Default | E |
+-----+---+---+---+---+-------------+--------+--------+---------+---+
| TBD |   |   |   |   | Repeat      | opaque |   8-40 | (none)  | x |
+-----+---+---+---+---+-------------+--------+--------+---------+---+

        C=Critical, U=Unsafe, N=NoCacheKey, R=Repeatable, 
        E=Encrypt and Integrity Protect (when using OSCOAP)
        
</pre>
<p class="figure">Figure 1: Repeat Option Summary</p>
<p id="rfc.section.2.1.p.2">The value of the Repeat option MUST be a (pseudo-)random bit string of a length of at least 64 bits. A new (pseudo-)random bit string MUST be generated by the CoAP server for each use of the Repeat option.</p>
<h1 id="rfc.section.2.2"><a href="#rfc.section.2.2">2.2.</a> <a href="#repeat-processing" id="repeat-processing">Repeat Processing</a></h1>
<p id="rfc.section.2.2.p.1">It is important to identify under what conditions a CoAP request to a resource is required to be fresh. These conditions can for example include what resource is requested, the request method and other data in the request, and conditions in the environment such as the state of the server or the time of the day.</p>
<p id="rfc.section.2.2.p.2">A CoAP server MAY include the Repeat option in a response. The Repeat option MUST NOT be used with empty CoAP requests.  If the server receives a request which has freshness requirements, and the request does not contain the Repeat option, the CoAP server SHOULD send a 4.03 Forbidden response with a Repeat option. The CoAP server SHOULD cache the transmitted Repeat option value and the response transmit time (here denoted t0).</p>
<p id="rfc.section.2.2.p.3">Upon receiving a response with the Repeat option within the EXCHANGE_LIFETIME (<a href="#RFC7252">[RFC7252]</a>) of the original request, the CoAP client SHOULD echo the Repeat option with the same value in a new request to the CoAP server. Upon receiving a 4.03 Forbidden response with the Repeat option in response to a request within the EXCHANGE_LIFETIME of the original request, the CoAP client SHOULD resend the original request. The CoAP client MAY send a different request compared to the original request.</p>
<p id="rfc.section.2.2.p.4">CoAP messages containing the Repeat option MUST be integrity protected, e.g. using DTLS or OSCOAP (<a href="#I-D.ietf-core-object-security">[I-D.ietf-core-object-security]</a>).</p>
<p id="rfc.section.2.2.p.5">If the server receives a request which has freshness requirements, and the request contains the Repeat option, the CoAP server MUST verify that the option value equals a cached value; otherwise the request is not processed further.  The CoAP server MUST calculate the round-trip time RTT = (t1 - t0), where t1 is the request receive time.  The CoAP server MUST only accept requests with a round-trip time below a certain threshold T, i.e. RTT &lt; T, otherwise the request is not processed further, and an error message MAY be sent. The threshold T is application specific, its value depends e.g. on the freshness requirements of the request. An example message flow is illustrated in <a href="#repeat-figure">Figure 2</a>.</p>
<p id="rfc.section.2.2.p.6">If the CoAP server loses time synchronization, e.g. due to reboot, it MUST delete all cached Repeat option values and response transmission times.</p>
<div id="rfc.figure.2"/>
<div id="repeat-figure"/>
<pre>
                Client  Server
                   |      |
                   +-----&gt;|        Code: 0.03 (PUT)
                   | PUT  |       Token: 0x41
                   |      |    Uri-Path: lock
                   |      |     Payload: 0 (Unlock)
                   |      |
                   |&lt;-----+ t0     Code: 4.03 (Forbidden)
                   | 4.03 |       Token: 0x41
                   |      |      Repeat: 0x6c880d41167ba807
                   |      |
                   +-----&gt;| t1     Code: 0.03 (PUT)
                   | PUT  |       Token: 0x42
                   |      |    Uri-Path: lock
                   |      |      Repeat: 0x6c880d41167ba807
                   |      |     Payload: 0 (Unlock)
                   |      |
                   |&lt;-----+        Code: 2.04 (Changed)
                   | 2.04 |       Token: 0x42
                   |      |

</pre>
<p class="figure">Figure 2: Repeat option message flow</p>
<p id="rfc.section.2.2.p.7">Constrained implementations can use the mechanisms outlined in <a href="#repeat-state">Section 7.1</a> to minimize the memory impact of having Repeat options unanswered from many clients.</p>
<h1 id="rfc.section.2.3"><a href="#rfc.section.2.3">2.3.</a> <a href="#applications" id="applications">Applications</a></h1>
<p/>

<ol>
  <li>Actuation requests often require freshness guarantees to avoid delay attacks. For multiple actuations in rapid sequence between the same client and server it may suffice with repeating the first request.</li>
  <li>If a server reboots during operation it may need to synchronize state or time with requesting clients before continuing interaction. For example, with OSCOAP it is possible to reuse a persistently stored security context by synchronizing the Partial IV (sequence number) using the Repeat option.</li>
  <li>When a device joins a multicast/broadcast group the device may need to synchronize state with the sender to ensure that the received messages are fresh. For certain broadcast types (e.g. when the inter-message time interval is known to the receiver) the Repeat option may only need to be applied to the first message to ensure freshness.</li>
</ol>
<h1 id="rfc.section.3"><a href="#rfc.section.3">3.</a> <a href="#request-tag" id="request-tag">The Request-Tag Option</a></h1>
<p id="rfc.section.3.p.1">The Request-Tag is intended for use as a short-lived identifier for keeping apart distinct blockwise operations on one resource from one client. It enables the receiving CoAP server to reliably assemble request payloads (blocks) to their message bodies when the individual payloads are integrity proteted, and it enables the sending CoAP server to process simultaneous operations on a single resource if the server supports it.</p>
<h1 id="rfc.section.3.1"><a href="#rfc.section.3.1">3.1.</a> <a href="#req-tag-format" id="req-tag-format">Option Format</a></h1>
<p id="rfc.section.3.1.p.1">The Request-Tag option has the same properties as the Block1 option: it is critical, unsafe, not part of the cache-key, and not repeatable, see <a href="#req-tag-table">Figure 3</a>.</p>
<div id="rfc.figure.3"/>
<div id="req-tag-table"/>
<pre>
+-----+---+---+---+---+-------------+--------+--------+---------+---+
| No. | C | U | N | R | Name        | Format | Length | Default | E |
+-----+---+---+---+---+-------------+--------+--------+---------+---+
| TBD | x | x | - |   | Request-Tag | opaque |    0-8 | (none)  | * |
+-----+---+---+---+---+-------------+--------+--------+---------+---+

            C=Critical, U=Unsafe, N=NoCacheKey, R=Repeatable,
            E=Encrypt and Integrity Protect (when using OSCOAP)
            
</pre>
<p class="figure">Figure 3: Request-Tag Option Summary</p>
<p id="rfc.section.3.1.p.2">Every message in which the Block1 option is set is considered to carry a Request-Tag value that can be compared for equality with any other such message&#8217;s value.  Absence of the Request-Tag option implies a value that is distinct from any value of a message with the Request-Tag option set, and equal to that of any other message without the Request-Tag option.  Messages with the Request-Tag option set have equal Request-Tag values if and only if their option lengths and option values are equal.</p>
<p id="rfc.section.3.1.p.3">Request-Tag, like the Block1 option, is a special class E option in terms of OSCOAP processing (see section 4.3.1.2 of <a href="#I-D.ietf-core-object-security">[I-D.ietf-core-object-security]</a>): The Request-Tag MAY be an inner or outer option. In case of inner, it is encrypted and integrity protected between CoAP client and server, and provides message body identification in case of end-to-end fragmentation of requests. In case of outer, it is visible to proxies and labels message bodies in case of hop-by-hop fragmentation of requests.  (TBD: Move to OSCOAP)</p>
<p id="rfc.section.3.1.p.4">The value of the Request-Tag option MUST be different from other Request-Tag values used by the CoAP client in any other blockwise request operations to the same resource.  It is generated by the CoAP client providing the resource, which may generate it in any number of ways including a version, checksum, hash, or time. (Clients are encouraged to generate compact values) (TBD: previous sentences analogous to text about ETag in RFC7252, just testing them here)</p>
<p id="rfc.section.3.1.p.5">The Request-Tag value of an initiated operation is chosen by the client in such a way that a tag value is not equal to any other operation that is not concluded. What constitutes a concluded operation depends on the application, and is outlined individually in <a href="#req-tag-applications">Section 3.3</a>.</p>
<h1 id="rfc.section.3.2"><a href="#rfc.section.3.2">3.2.</a> <a href="#request-tag-processing" id="request-tag-processing">Request-Tag Processing</a></h1>
<p id="rfc.section.3.2.p.1">A CoAP client MAY set the Request-Tag option to allow the CoAP server to differentiate between different representations of the same resource. If the Request-Tag option is set, the CoAP client MAY perform simultaneous operations that utilize Block1 fragmentation from the same endpoint towards the same resource, lifting the limitation of <a href="#RFC7959">[RFC7959]</a> section 2.5. A CoAP client MUST set the Request-Tag option in the case of different concurrent blockwise request operations to the same resource. If the CoAP client is running a blockwise request operation without the Request-Tag, and is concurrently starting another blockwise request operations to the same resource, then the CoAP client MUST set the Request-Tag.</p>
<p id="rfc.section.3.2.p.2">If a CoAP proxy fragments a request with the Object-Security option, using the Block1 option, then the proxy MUST set the Request-Tag option. (TBD: Move previous sentence to OSCOAP?)</p>
<p id="rfc.section.3.2.p.3">If the CoAP server receives a message with a Block1 option and Request-Tag option then server MUST NOT act on any block in the same blockwise operation that has a different Request-Tag set. A server MUST NOT act on blocks with and blocks without Request-Tag option in the same blockwise operation. The CoAP server is still under no obligation to keep state of more than one transaction. When an operation is in progress and a second one cannot be served at the same time, the CoAP server MUST respond to the second request with a 5.03 (Service Unavailable) response code and SHOULD indicate the time it is willing to wait for additional blocks in the first operation using the Max-Age option, as specified in Section 5.9.3.4 of <a href="#RFC7252">[RFC7252]</a>.</p>
<p id="rfc.section.3.2.p.4">(TBD If we want the functionality that the client should be able to interupt an operation in progress and perform a different operation, then that should IMHO not be implemented as only sendning the other operation. Instead an &#8220;interrupt&#8221; message should be sent. RFC7959 2.9.2 mentions that if a different Content-Format is indicated than the server expects from the current state of the resource that can lead to 4.08, should we recommend something like that?)</p>
<p id="rfc.section.3.2.p.5">A CoAP server receiving a Request-Tag MUST treat it as opaque and make no assumptions about its content or structure.</p>
<p id="rfc.section.3.2.p.6">The option is not used in responses.</p>
<p id="rfc.section.3.2.p.7">If a request that uses Request-Tag is rejected with 4.02 Bad Option, the CoAP client MAY retry the operation without it, but then it MUST serialize all operations that affect the same resource. Security requirements can forbid dropping the Request-Tag option.</p>
<h1 id="rfc.section.3.3"><a href="#rfc.section.3.3">3.3.</a> <a href="#req-tag-applications" id="req-tag-applications">Applications</a></h1>
<h1 id="rfc.section.3.3.1"><a href="#rfc.section.3.3.1">3.3.1.</a> <a href="#parallel-blockwise-transfers" id="parallel-blockwise-transfers">Parallel blockwise transfers</a></h1>
<p id="rfc.section.3.3.1.p.1">&#8230;</p>
<h1 id="rfc.section.3.3.2"><a href="#rfc.section.3.3.2">3.3.2.</a> <a href="#body-integrity-based-on-payload-integrity" id="body-integrity-based-on-payload-integrity">Body integrity based on Payload integrity</a></h1>
<p id="rfc.section.3.3.2.p.1">Clients can use the Request-Tag option to ensure that a request body is assembled only from the payloads of the messages the client created for that operation. In order to gain that protection, these rules apply:</p>
<p/>

<ul>
  <li>The client MUST NOT reuse a Request-Tag value within a security association unless all previous operations on the same resource that used the same Request-Tag value have concluded.  <br/><br/> Note that the server needs to verify that all blocks within an operation come from the same security association, because the security association is a part of the endpoint as per <a href="#RFC7252">[RFC7252]</a>, and blocks need to be transferred between the same set of endpoints (TBD does it actually say that anywhere? Didn&#8217;t find it in 7959).</li>
  <li>The client MUST NOT consider an operation as concluded unless all of the messages the client previously sent in the operation have been confirmed by the message integrity protection mechanism to be considered invalid by the server in a replay.  <br/><br/> Typically, this confirmation can result either from reception of an ACK to the message, or because the message&#8217;s sequence number is old enough to be outside the server&#8217;s receive window.</li>
</ul>
<p id="rfc.section.3.3.2.p.3">Authors of other documents (eg. <a href="#I-D.ietf-core-object-security">[I-D.ietf-core-object-security]</a>) are invited to mandate this behavior for clients that execute blockwise interactions over secured transports. Thus, the server can rely on the conforming client to set the Request-Tag option when required, and thus rely on the integrity of the assembled body.</p>
<h1 id="rfc.section.4"><a href="#rfc.section.4">4.</a> <a href="#etag" id="etag">The ETag Option</a></h1>
<p id="rfc.section.4.p.1">For dynamically changing resources the Block2 Option MUST be used in conjunction with the ETag Option (<a href="#RFC7252">[RFC7252]</a>, Section&#160;5.10.6), to ensure that the blocks being reassembled are from the same version of the representation: The server MUST include an ETag Option in each response.</p>
<h1 id="rfc.section.5"><a href="#rfc.section.5">5.</a> <a href="#iana" id="iana">IANA Considerations</a></h1>
<h1 id="rfc.section.6"><a href="#rfc.section.6">6.</a> <a href="#sec-cons" id="sec-cons">Security Considerations</a></h1>
<p id="rfc.section.6.p.1">Servers that store the Repeat challenge per client can be attacked for resource exhaustion, and should consider minimizing the state kept per client, eg. using a mechanism as described in <a href="#repeat-state">Section 7.1</a>.</p>
<p id="rfc.section.6.p.2">&#8211; back</p>
<h1 id="rfc.section.7"><a href="#rfc.section.7">7.</a> <a href="#appendix" id="appendix">Appendix</a></h1>
<h1 id="rfc.section.7.1"><a href="#rfc.section.7.1">7.1.</a> <a href="#repeat-state" id="repeat-state">Minimizing the state kept for the Repeat Opption</a></h1>
<p id="rfc.section.7.1.p.1">[from Repeat Processing]</p>
<p id="rfc.section.7.1.p.2">Instead of caching Repeat option values and response transmission times, the CoAP server MAY use the encryption of the response transmit time t0 as Repeat option value. Such a scheme needs to ensure that the CoAP server can detect a replay of a previous encrypted response transmit time.</p>
<p id="rfc.section.7.1.p.3">For example, the CoAP server MAY encrypt t0 with AES-CCM-128-64-64 using a (pseudo-)random secret key k generated and cached by the server. A unique IV MUST be used with each encryption, e.g. using a sequence number. If the CoAP server loses time synchronization, e.g. due to reboot, then k MUST be deleted and replaced by a new random secret key. When using encrypted response transmit times, the Repeat processing is modified in the following way: The verification of cached option value in the CoAP server processing is replaced by the verification of the integrity of the encrypted option value using the cached key and IV (e.g. sequence number).</p>
<p id="rfc.section.7.1.p.4">[from Security Considerations]</p>
<p id="rfc.section.7.1.p.5">TBD - for now some unstructured text:</p>
<p id="rfc.section.7.1.p.6">The CoAP server may use an encryption algorithm in CTR-mode would from a security point be like sending (value = t0).  ECB-mode or CCM-mode would work, but would expand the value length.  With CCM, the CoAP server might also bind the option value to request (value = AEAD(k, t0, parts of request)).</p>
<p/>

<ul>
  <li>To be secure, parts of request needs to be unique</li>
  <li>Comparing the list of cached values with encryption of transmit time:  <ul><li>size of cached data (key vs list)</li><li>size of message (typically larger with AEAD)</li><li>computation (encryption + decryption vs generation new nonce + cache + lookup)</li></ul></li>
</ul>
<p id="rfc.section.7.1.p.8">Encryption instead of cache mainly useful if many simultaneous requests such that list becomes long? DoS protection? Hybrid scheme (if Repeat value not in cache, CoAP server tries to verify before failing)?</p>
<h1 id="rfc.references"><a href="#rfc.references">8.</a> References</h1>
<h1 id="rfc.references.1"><a href="#rfc.references.1">8.1.</a> Normative References</h1>
<table>
  <tbody>
    <tr>
      <td class="reference">
        <b id="RFC2119">[RFC2119]</b>
      </td>
      <td class="top"><a>Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, DOI 10.17487/RFC2119, March 1997.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC7252">[RFC7252]</b>
      </td>
      <td class="top"><a>Shelby, Z.</a>, <a>Hartke, K.</a> and <a>C. Bormann</a>, "<a href="http://tools.ietf.org/html/rfc7252">The Constrained Application Protocol (CoAP)</a>", RFC 7252, DOI 10.17487/RFC7252, June 2014.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC7959">[RFC7959]</b>
      </td>
      <td class="top"><a>Bormann, C.</a> and <a>Z. Shelby</a>, "<a href="http://tools.ietf.org/html/rfc7959">Block-Wise Transfers in the Constrained Application Protocol (CoAP)</a>", RFC 7959, DOI 10.17487/RFC7959, August 2016.</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.references.2"><a href="#rfc.references.2">8.2.</a> Informative References</h1>
<table>
  <tbody>
    <tr>
      <td class="reference">
        <b id="I-D.amsuess-core-request-tag">[I-D.amsuess-core-request-tag]</b>
      </td>
      <td class="top"><a>Amsuess, C.</a>, "<a href="http://tools.ietf.org/html/draft-amsuess-core-request-tag-00">Request-Tag option</a>", Internet-Draft draft-amsuess-core-request-tag-00, March 2017.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="I-D.ietf-core-object-security">[I-D.ietf-core-object-security]</b>
      </td>
      <td class="top"><a>Selander, G.</a>, <a>Mattsson, J.</a>, <a>Palombini, F.</a> and <a>L. Seitz</a>, "<a href="http://tools.ietf.org/html/draft-ietf-core-object-security-03">Object Security of CoAP (OSCOAP)</a>", Internet-Draft draft-ietf-core-object-security-03, May 2017.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="I-D.mattsson-core-coap-actuators">[I-D.mattsson-core-coap-actuators]</b>
      </td>
      <td class="top"><a>Mattsson, J.</a>, <a>Fornehed, J.</a>, <a>Selander, G.</a> and <a>F. Palombini</a>, "<a href="http://tools.ietf.org/html/draft-mattsson-core-coap-actuators-02">Controlling Actuators with CoAP</a>", Internet-Draft draft-mattsson-core-coap-actuators-02, November 2016.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC6347">[RFC6347]</b>
      </td>
      <td class="top"><a>Rescorla, E.</a> and <a>N. Modadugu</a>, "<a href="http://tools.ietf.org/html/rfc6347">Datagram Transport Layer Security Version 1.2</a>", RFC 6347, DOI 10.17487/RFC6347, January 2012.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC7641">[RFC7641]</b>
      </td>
      <td class="top"><a>Hartke, K.</a>, "<a href="http://tools.ietf.org/html/rfc7641">Observing Resources in the Constrained Application Protocol (CoAP)</a>", RFC 7641, DOI 10.17487/RFC7641, September 2015.</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.authors">
  <a href="#rfc.authors">Authors' Addresses</a>
</h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Christian Ams&#252;ss</span> 
	  <span class="n hidden">
		<span class="family-name">Amsuess</span>
	  </span>
	</span>
	<span class="org vcardline">Energy Harvesting Solutions</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:c.amsuess@energyharvesting.at">c.amsuess@energyharvesting.at</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">John Mattsson</span> 
	  <span class="n hidden">
		<span class="family-name">Mattsson</span>
	  </span>
	</span>
	<span class="org vcardline">Ericsson AB</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:john.mattsson@ericsson.com">john.mattsson@ericsson.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">G&#246;ran Selander</span> 
	  <span class="n hidden">
		<span class="family-name">Selander</span>
	  </span>
	</span>
	<span class="org vcardline">Ericsson AB</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:goran.selander@ericsson.com">goran.selander@ericsson.com</a></span>

  </address>
</div>

</body>
</html>
